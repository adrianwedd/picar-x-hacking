#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/px-env"

python - "$@" <<'PY'
from __future__ import annotations

import argparse
import json
import os
import subprocess

from pxh.logging import log_event
from pxh.state import update_session


def run_tool(command, extra_env=None):
    env = os.environ.copy()
    env.setdefault("PROJECT_ROOT", os.environ["PROJECT_ROOT"])
    env.setdefault("PX_BYPASS_SUDO", os.environ.get("PX_BYPASS_SUDO", "0"))
    if extra_env:
        env.update(extra_env)
    result = subprocess.run(
        command,
        capture_output=True,
        text=True,
        check=False,
        env=env,
    )
    payload = {
        "cmd": " ".join(command),
        "returncode": result.returncode,
        "stdout": result.stdout[-2048:],
        "stderr": result.stderr[-2048:],
    }
    try:
        payload["data"] = json.loads(result.stdout.splitlines()[-1])
    except Exception:
        payload["data"] = None
    return payload


def main() -> int:
    parser = argparse.ArgumentParser(description="Perform a choreographed demo routine")
    parser.add_argument("--speed", type=int, default=28)
    parser.add_argument("--duration", type=float, default=4.0)
    parser.add_argument("--rest", type=float, default=1.0)
    parser.add_argument("--voice", default="Enjoy the PiCar-X dance demo!", help="Announcement message")
    args = parser.parse_args()

    dry_mode = os.environ.get("PX_DRY", "1") != "0"
    sequence = []

    if args.voice:
        voice_payload = run_tool(["bin/tool-voice"], {"PX_TEXT": args.voice, "PX_DRY": "1" if dry_mode else "0"})
        voice_payload["name"] = "voice"
        sequence.append(voice_payload)

    circle_payload = run_tool(
        ["bin/tool-circle"],
        {
            "PX_SPEED": str(args.speed),
            "PX_DURATION": f"{args.duration:.2f}",
            "PX_DRY": "1" if dry_mode else "0",
        },
    )
    circle_payload["name"] = "circle"
    sequence.append(circle_payload)

    figure_payload = run_tool(
        ["bin/tool-figure8"],
        {
            "PX_SPEED": str(args.speed),
            "PX_DURATION": f"{args.duration:.2f}",
            "PX_REST": f"{args.rest:.2f}",
            "PX_DRY": "1" if dry_mode else "0",
        },
    )
    figure_payload["name"] = "figure8"
    sequence.append(figure_payload)

    finale_voice = run_tool(["bin/tool-voice"], {"PX_TEXT": "Dance complete", "PX_DRY": "1" if dry_mode else "0"})
    finale_voice["name"] = "voice"
    sequence.append(finale_voice)

    status = "ok" if all(item["returncode"] == 0 for item in sequence) else "error"
    summary = {
        "status": status,
        "dry": dry_mode,
        "sequence": sequence,
    }
    log_event("dance", summary)
    update_session(history_entry={"event": "dance", "status": status})
    print(json.dumps(summary, ensure_ascii=False))
    return 0 if status == "ok" else 1


if __name__ == "__main__":
    raise SystemExit(main())
PY
