#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/px-env"

python - "$@" <<'PY'
from __future__ import annotations

import json
import os
import subprocess
from pathlib import Path

from pxh.logging import log_event
from pxh.state import load_session, update_session

PROJECT_ROOT = Path(os.environ["PROJECT_ROOT"])
PX_FIGURE8 = Path(os.environ.get("PX_FIGURE8_CMD", PROJECT_ROOT / "bin/px-figure8"))

MIN_SPEED = int(os.environ.get("PX_FIGURE8_MIN_SPEED", "0"))
MAX_SPEED = int(os.environ.get("PX_FIGURE8_MAX_SPEED", "60"))
MIN_DURATION = float(os.environ.get("PX_FIGURE8_MIN_DURATION", "1.0"))
MAX_DURATION = float(os.environ.get("PX_FIGURE8_MAX_DURATION", "12.0"))
MIN_REST = float(os.environ.get("PX_FIGURE8_MIN_REST", "0.0"))
MAX_REST = float(os.environ.get("PX_FIGURE8_MAX_REST", "5.0"))


def clamp(value: float, minimum: float, maximum: float) -> float:
    return max(minimum, min(maximum, value))


def main() -> int:
    dry_mode = os.environ.get("PX_DRY", "1") != "0"
    session = load_session()
    if not dry_mode and not session.get("confirm_motion_allowed", False):
        payload = {
            "status": "blocked",
            "reason": "motion not confirmed safe",
        }
        log_event("figure8", payload)
        print(json.dumps(payload))
        return 2

    try:
        speed = int(float(os.environ.get("PX_SPEED", "30")))
        duration = float(os.environ.get("PX_DURATION", "6"))
        rest = float(os.environ.get("PX_REST", "1.5"))
    except ValueError:
        payload = {
            "status": "error",
            "error": "invalid numeric parameters",
        }
        log_event("figure8", payload)
        print(json.dumps(payload))
        return 1

    speed = int(clamp(speed, MIN_SPEED, MAX_SPEED))
    duration = clamp(duration, MIN_DURATION, MAX_DURATION)
    rest = clamp(rest, MIN_REST, MAX_REST)

    command = []
    if os.environ.get("PX_BYPASS_SUDO", "0") != "1":
        python_path = os.environ.get("PYTHONPATH", "")
        command.extend(["sudo", "-n", "env", f"PYTHONPATH={python_path}"])
    command.extend([
        str(PX_FIGURE8),
        "--speed",
        str(speed),
        "--duration",
        f"{duration:.2f}",
        "--rest",
        f"{rest:.2f}",
    ])
    if dry_mode:
        command.append("--dry-run")

    result = subprocess.run(
        command,
        capture_output=True,
        text=True,
        check=False,
    )

    rc = result.returncode
    stdout = result.stdout
    stderr = result.stderr

    history_entry = {
        "event": "figure8",
        "dry": dry_mode,
        "speed": speed,
        "duration": duration,
        "rest": rest,
        "rc": rc,
    }

    fields = {
        "last_action": "tool_figure8",
    }
    if not dry_mode and rc == 0:
        fields["last_motion"] = "px-figure8"
    if dry_mode:
        fields["mode"] = "dry-run"

    update_session(fields=fields, history_entry=history_entry)

    payload = {
        "status": "ok" if rc == 0 else "error",
        "returncode": rc,
        "dry": dry_mode,
        "speed": speed,
        "duration": duration,
        "rest": rest,
        "stdout": stdout[-2048:],
        "stderr": stderr[-2048:],
    }
    log_event("figure8", payload)
    print(json.dumps(payload))
    return 0 if rc == 0 else rc


if __name__ == "__main__":
    raise SystemExit(main())
PY
