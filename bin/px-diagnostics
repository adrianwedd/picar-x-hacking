#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/px-env"

python - "$@" <<'PY'
from __future__ import annotations

import argparse
import json
import os
import re
import subprocess
import tempfile
from pathlib import Path
from typing import Any, Dict, List

from pxh.logging import log_event
from pxh.state import update_session


def run_tool(command: List[str], extra_env: Dict[str, str] | None = None) -> Dict[str, Any]:
    env = os.environ.copy()
    env.setdefault("PROJECT_ROOT", os.environ["PROJECT_ROOT"])
    env.setdefault("PX_BYPASS_SUDO", os.environ.get("PX_BYPASS_SUDO", "0"))
    if extra_env:
        env.update(extra_env)
    result = subprocess.run(
        command,
        capture_output=True,
        text=True,
        check=False,
        env=env,
    )
    payload: Dict[str, Any] = {
        "cmd": " ".join(command),
        "returncode": result.returncode,
        "stdout": result.stdout[-2048:],
        "stderr": result.stderr[-2048:],
    }
    try:
        payload["data"] = json.loads(result.stdout.splitlines()[-1])
    except Exception:
        payload["data"] = None
    return payload


def main() -> int:
    parser = argparse.ArgumentParser(description="PiCar-X diagnostics sweep")
    parser.add_argument("--no-motion", action="store_true", help="Skip motion tests even if not in dry-run")
    parser.add_argument("--short", action="store_true", help="Skip weather and camera checks for speed")
    args = parser.parse_args()

    dry_mode = os.environ.get("PX_DRY", "1") != "0"
    results: Dict[str, Any] = {
        "status": "ok",
        "dry": dry_mode,
        "checks": [],
    }

    status_info = run_tool(["bin/tool-status"], {"PX_DRY": "1" if dry_mode else "0"})
    results["checks"].append({"name": "status", **status_info})
    status_payload = status_info.get("data", {}) or {}
    battery_ok = status_payload.get("battery_ok")
    if battery_ok is False:
        results["status"] = "warn"
        results.setdefault("warnings", []).append("battery low")

    sensor_check = {"name": "sensors", "status": "ok"}
    stdout = status_info.get("stdout", "")
    distance = None
    match = re.search(r"Ultrasonic distance: ([\-\d.]+)", stdout)
    if match:
        try:
            distance = float(match.group(1))
        except ValueError:
            distance = None
    grayscale_match = re.search(r"Grayscale readings: \[(.*?)\]", stdout)
    if grayscale_match:
        try:
            sensor_check["grayscale"] = [float(part.strip()) for part in grayscale_match.group(1).split(",")]
        except ValueError:
            sensor_check["grayscale"] = None
    sensor_check["distance_cm"] = distance
    if distance is None:
        sensor_check["status"] = "warn"
    sensor_check["raw"] = stdout[-512:]
    results["checks"].append(sensor_check)

    if not args.short:
        weather_info = run_tool(["bin/tool-weather"], {"PX_DRY": "1"})
        weather_info["name"] = "weather"
        results["checks"].append(weather_info)

    do_motion = not (dry_mode or args.no_motion)
    motion_check = None
    if do_motion:
        motion_env = {"PX_DRY": "1" if dry_mode else "0", "PX_SPEED": "25", "PX_DURATION": "2"}
        motion_check = run_tool(["bin/tool-circle"], motion_env)
        motion_check["name"] = "circle"
        results["checks"].append(motion_check)
        if motion_check["returncode"] != 0:
            results["status"] = "error"

    camera_check = None
    if not dry_mode and not args.short:
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as tmp:
            image_path = Path(tmp.name)
        camera_check = run_tool(["rpicam-still", "--nopreview", "-t", "200", "-o", str(image_path)])
        camera_check["name"] = "camera"
        if camera_check["returncode"] == 0 and image_path.exists():
            camera_check["status"] = "ok"
            camera_check["file"] = str(image_path)
        else:
            camera_check["status"] = "error"
            results["status"] = "warn"
            results.setdefault("warnings", []).append("camera capture failed")
        results["checks"].append(camera_check)
        if image_path.exists():
            try:
                image_path.unlink()
            except OSError:
                pass

    voice_summary = "Diagnostics complete: "
    voice_bits = []
    if battery_ok is False:
        voice_bits.append("battery below threshold")
    elif battery_ok:
        voice_bits.append("battery is healthy")
    if distance is not None:
        voice_bits.append(f"range {distance:.0f} cm")
    elif sensor_check["status"] != "ok":
        voice_bits.append("ultrasonic unavailable")
    if motion_check is not None:
        if motion_check["returncode"] == 0:
            voice_bits.append("motors responsive")
        else:
            voice_bits.append("motor test failed")
    if camera_check is not None:
        if camera_check.get("returncode") == 0:
            voice_bits.append("camera capture OK")
        else:
            voice_bits.append("camera capture failed")
    if not voice_bits:
        voice_bits.append("see logs")
    voice_summary += ", ".join(voice_bits)

    voice_info = run_tool(["bin/tool-voice"], {"PX_TEXT": voice_summary, "PX_DRY": "1" if dry_mode else "0"})
    voice_info["name"] = "voice"
    results["checks"].append(voice_info)

    log_event("diagnostics", results)
    update_session(history_entry={"event": "diagnostics", "status": results["status"]})
    print(json.dumps(results, ensure_ascii=False))
    return 0 if results["status"] != "error" else 1


if __name__ == "__main__":
    raise SystemExit(main())
PY
