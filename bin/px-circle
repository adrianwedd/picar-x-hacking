#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/px-env"

python - "$@" <<'PY'
import argparse
import datetime as dt
import os
import sys
import time
from pathlib import Path

LOG_DIR = Path(os.environ.get("LOG_DIR", Path.cwd() / "logs"))
LOG_FILE = Path(os.environ.get("PX_LOG_FILE", LOG_DIR / "px-circle.log"))


def log(message: str) -> None:
    timestamp = dt.datetime.now().isoformat(timespec="seconds")
    LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
    line = f"{timestamp} {message}"
    with LOG_FILE.open("a", encoding="utf-8") as handle:
        handle.write(line + "\n")
    print(line)


def clamp(value: float, minimum: float, maximum: float) -> float:
    return max(minimum, min(maximum, value))


def main(argv: list[str]) -> int:
    parser = argparse.ArgumentParser(description="Drive a gentle clockwise circle pattern")
    parser.add_argument("--speed", type=int, default=35, help="Wheel speed percentage (0-100)")
    parser.add_argument("--duration", type=float, default=6.0, help="Total pulse duration in seconds")
    parser.add_argument("--dry-run", action="store_true", help="Log the plan without moving")
    args = parser.parse_args(argv)

    speed = clamp(args.speed, 0, 100)
    if speed != args.speed:
        log(f"speed_clamped from={args.speed} to={speed}")
    duration = max(args.duration, 0.1)

    log(
        f"begin action=px-circle speed={speed} duration={duration:.2f}s dry_run={args.dry_run}"  # noqa: E501
    )

    steer_angle = 20
    pulses = 5
    pulse_time = max(duration / pulses, 0.2)
    coast_time = min(0.5, pulse_time / 2.0)

    if args.dry_run:
        for pulse in range(1, pulses + 1):
            log(
                f"dry_run pulse={pulse}/{pulses} angle={steer_angle} speed={speed} active={pulse_time:.2f}s"
            )
        log("complete dry_run=True")
        return 0

    try:
        from picarx import Picarx
    except Exception as exc:  # pragma: no cover
        log(f"error importing picarx detail={exc}")
        return 1

    px = Picarx()
    try:
        px.set_dir_servo_angle(steer_angle)
        for pulse in range(1, pulses + 1):
            log(
                f"pulse={pulse}/{pulses} angle={steer_angle} speed={speed} active={pulse_time:.2f}s"
            )
            px.forward(speed)
            time.sleep(pulse_time)
            px.stop()
            time.sleep(coast_time)
        log("stop_sequence initiating")
        px.stop()
        px.stop()
        log("complete dry_run=False")
    except KeyboardInterrupt:
        log("aborted by user")
        px.stop()
        px.stop()
        return 130
    except Exception as exc:  # pragma: no cover
        log(f"runtime_error detail={exc}")
        px.stop()
        px.stop()
        return 1
    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
PY
