#!/usr/bin/env bash
# boot-health: capture power/throttle diagnostics at boot and reset motors
# Logs to ~/picar-x-hacking/logs/boot-health.log
# Deploy to: ~/picar-x-hacking/bin/boot-health

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/px-env"

LOG_FILE="${LOG_DIR:-${SCRIPT_DIR}/../logs}/boot-health.log"
mkdir -p "$(dirname "$LOG_FILE")"

ts() { date -u +"%Y-%m-%dT%H:%M:%SZ"; }

log() {
    local level="$1" msg="$2"
    printf '{"ts":"%s","level":"%s","msg":"%s"}\n' "$(ts)" "$level" "$msg" >> "$LOG_FILE"
}

log_json() {
    # log_json LEVEL key=value [key=value ...]
    # Emits a valid JSON object with ts, level, and arbitrary string key-value pairs.
    local level="$1"; shift
    local json
    json="{\"ts\":\"$(ts)\",\"level\":\"${level}\""
    for pair in "$@"; do
        local k="${pair%%=*}" v="${pair#*=}"
        json+=",\"${k}\":\"${v}\""
    done
    json+="}"
    printf '%s\n' "$json" >> "$LOG_FILE"
}

# ── Throttle status ───────────────────────────────────────────────────────────
THROTTLED_RAW=$(vcgencmd get_throttled 2>/dev/null | cut -d= -f2 || echo "unavailable")
if [[ "$THROTTLED_RAW" == "unavailable" || "$THROTTLED_RAW" == "0x"* ]] && [[ "$THROTTLED_RAW" != "unavailable" ]]; then
    THROTTLED_DEC=$(( 16#${THROTTLED_RAW#0x} )) || THROTTLED_DEC=0
elif [[ "$THROTTLED_RAW" == "unavailable" ]]; then
    THROTTLED_DEC=-1  # sentinel: reading not available
else
    THROTTLED_DEC=0
fi

decode_throttle() {
    local val=$1
    local flags=()
    (( val & 0x1    )) && flags+=("under_voltage_now")
    (( val & 0x2    )) && flags+=("freq_capped_now")
    (( val & 0x4    )) && flags+=("throttled_now")
    (( val & 0x8    )) && flags+=("soft_temp_limit_now")
    (( val & 0x10000 )) && flags+=("under_voltage_occurred")
    (( val & 0x20000 )) && flags+=("freq_capped_occurred")
    (( val & 0x40000 )) && flags+=("throttled_occurred")
    (( val & 0x80000 )) && flags+=("soft_temp_limit_occurred")
    printf '%s' "${flags[*]:-none}"
}

if [[ "$THROTTLED_DEC" -eq -1 ]]; then
    FLAGS="unavailable"
else
    FLAGS=$(decode_throttle "$THROTTLED_DEC")
fi

# ── Voltages ──────────────────────────────────────────────────────────────────
V_CORE=$(vcgencmd measure_volts core  2>/dev/null | cut -d= -f2 || echo "unavailable")
V_SDRAM=$(vcgencmd measure_volts sdram_c 2>/dev/null | cut -d= -f2 || echo "unavailable")

# ── CPU temp ─────────────────────────────────────────────────────────────────
CPU_TEMP=$(vcgencmd measure_temp 2>/dev/null | cut -d= -f2 || echo "unavailable")

# ── Uptime at time of check ───────────────────────────────────────────────────
UPTIME_SEC=$(awk '{print int($1)}' /proc/uptime 2>/dev/null || echo "unavailable")

log_json "INFO" "msg=Boot health check" "throttled_raw=${THROTTLED_RAW}" "throttled_flags=${FLAGS}" "v_core=${V_CORE}" "v_sdram=${V_SDRAM}" "cpu_temp=${CPU_TEMP}" "uptime_sec=${UPTIME_SEC}"

# ── Warn if under-voltage occurred ───────────────────────────────────────────
if [[ "$FLAGS" == "unavailable" ]]; then
    log_json "WARN" "msg=throttle reading unavailable from vcgencmd" "throttled_raw=${THROTTLED_RAW}"
elif [[ "$FLAGS" == *"under_voltage"* ]]; then
    log_json "WARN" "msg=Under-voltage detected during boot - check battery/hat power rail" "flags=${FLAGS}"
    echo "WARNING: under-voltage flags set: $FLAGS" >&2
fi

# ── Motor reset (stop any spurious PWM from boot) ────────────────────────────
# The Robot Hat may leave PWM pins in an undefined state during power-on.
# Calling px-stop resets all motors and servos to neutral.
# ── Motor reset (stop any spurious PWM from boot) ────────────────────────────
# Use system python3 (has robot_hat) and monkey-patch os.getlogin so picarx.py
# doesn't fail when running without a controlling terminal under systemd.
log "INFO" "Running motor reset to clear any boot-time PWM state"
if /usr/bin/python3 - >> "$LOG_FILE" 2>&1 <<'PY'
import os, sys
# Patch os.getlogin before picarx imports it via fileDB
_user = os.environ.get("LOGNAME") or os.environ.get("USER") or "pi"
os.getlogin = lambda: _user

sys.path.insert(0, "/home/pi/picar-x")
from picarx import Picarx
px = Picarx()
px.stop()
px.set_dir_servo_angle(0)
px.set_cam_pan_angle(0)
px.set_cam_tilt_angle(0)
print("Motor reset OK")
PY
then
    log "INFO" "Motor reset OK"
else
    log "WARN" "Motor reset failed - servos/motors may be in unknown state"
fi

echo "Boot health logged to $LOG_FILE (throttle: ${FLAGS:-none})"
