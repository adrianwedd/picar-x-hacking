#!/usr/bin/env python3
from __future__ import annotations

import json
import os
import sys
import urllib.error
import urllib.parse
import urllib.request

ALLOWED_TOOLS = {
    "tool_status",
    "tool_circle",
    "tool_figure8",
    "tool_stop",
    "tool_voice",
    "tool_weather",
}


def _int_from_env(var: str, default: int | None) -> int | None:
    raw = os.environ.get(var)
    if raw is None:
        return default
    raw_stripped = raw.strip()
    if raw_stripped == "":
        return default
    try:
        value = int(raw_stripped)
    except ValueError:
        return default
    return value


def main() -> int:
    prompt = sys.stdin.read()
    if not prompt:
        return 0
    model = os.environ.get("CODEX_OLLAMA_MODEL", "deepseek-coder:1.3b")
    host = os.environ.get("OLLAMA_HOST", "http://127.0.0.1:11434")
    if not host.startswith(("http://", "https://")):
        host = "http://" + host
    url = host.rstrip("/") + "/api/generate"
    options: dict[str, object] = {
        "temperature": float(os.environ.get("CODEX_OLLAMA_TEMPERATURE", "0.2")),
    }
    num_predict = _int_from_env("CODEX_OLLAMA_NUM_PREDICT", 64)
    if num_predict and num_predict > 0:
        options["num_predict"] = num_predict
    payload = {
        "model": model,
        "prompt": prompt,
        "stream": False,
        "format": "json",
        "options": options,
    }
    data_bytes = json.dumps(payload).encode("utf-8")
    request = urllib.request.Request(url, data=data_bytes, headers={"Content-Type": "application/json"})
    try:
        with urllib.request.urlopen(request, timeout=600) as response:
            data = json.load(response)
    except urllib.error.HTTPError as exc:
        sys.stderr.write(f"ollama HTTP error {exc.code}: {exc.reason}\n")
        return 1
    except urllib.error.URLError as exc:
        sys.stderr.write(f"ollama connection error: {exc.reason}\n")
        return 1
    output = data.get("response", "")
    normalized = None
    try:
        parsed = json.loads(output)
    except json.JSONDecodeError:
        parsed = None
    if isinstance(parsed, dict):
        tool = parsed.get("tool") or parsed.get("tool_name")
        params = parsed.get("params") if isinstance(parsed.get("params"), dict) else {}
        if tool in ALLOWED_TOOLS:
            normalized = {"tool": tool, "params": params}
    if normalized is not None:
        output = json.dumps(normalized)
    sys.stdout.write(output)
    if not output.endswith("\n"):
        sys.stdout.write("\n")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
