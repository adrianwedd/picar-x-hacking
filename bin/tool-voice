#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/px-env"

python - "$@" <<'PY'
from __future__ import annotations

import json
import os
import shutil
import subprocess
from pathlib import Path

from pxh.logging import log_event
from pxh.state import update_session

PROJECT_ROOT = Path(os.environ["PROJECT_ROOT"])
CONFIGURED_PLAYER = os.environ.get("PX_VOICE_PLAYER")
DEFAULT_PLAYER = None
if CONFIGURED_PLAYER:
    DEFAULT_PLAYER = CONFIGURED_PLAYER
else:
    for candidate in ("espeak", "say"):
        if shutil.which(candidate):
            DEFAULT_PLAYER = candidate
            break


def main() -> int:
    text = os.environ.get("PX_TEXT")
    if not text:
        payload = {"status": "error", "error": "PX_TEXT environment variable is required"}
        log_event("voice", payload)
        print(json.dumps(payload))
        return 1

    dry_mode = os.environ.get("PX_DRY", "1") != "0"
    payload = {
        "status": "ok",
        "dry": dry_mode,
        "text": text,
    }

    if not DEFAULT_PLAYER:
        payload["note"] = "no speech engine available"
    else:
        if DEFAULT_PLAYER == "espeak":
            rate = os.environ.get("PX_VOICE_RATE", "150")
            device = os.environ.get("PX_VOICE_DEVICE", "plughw:3,0")
            es_res = subprocess.run(
                [DEFAULT_PLAYER, "-s", rate, "--stdout", text],
                capture_output=True,
                text=False,
                check=False,
            )
            payload["player"] = f"espeak->{device}"
            payload["returncode"] = es_res.returncode
            payload["stdout"] = es_res.stdout[-1024:].decode("latin1", errors="ignore")
            payload["stderr"] = es_res.stderr[-1024:].decode("latin1", errors="ignore")
            if es_res.returncode == 0 and shutil.which("aplay"):
                play_cmd = ["aplay", "-q", "-D", device]
                play_res = subprocess.run(
                    play_cmd,
                    input=es_res.stdout,
                    capture_output=True,
                    text=False,
                    check=False,
                )
                payload["player"] = f"espeak+aplay({device})"
                payload["returncode"] = play_res.returncode
                payload["stdout"] = play_res.stdout[-1024:].decode("latin1", errors="ignore")
                payload["stderr"] = play_res.stderr[-1024:].decode("latin1", errors="ignore")
            elif es_res.returncode == 0:
                payload["note"] = "aplay not found"
        else:
            command = [DEFAULT_PLAYER, text]
            result = subprocess.run(command, capture_output=True, text=True, check=False)
            payload["player"] = DEFAULT_PLAYER
            payload["returncode"] = result.returncode
            payload["stdout"] = result.stdout[-1024:]
            payload["stderr"] = result.stderr[-1024:]

    update_session(
        fields={"last_action": "tool_voice"},
        history_entry={"event": "voice", "text": text[:120], "dry": dry_mode},
    )
    log_event("voice", payload)
    print(json.dumps(payload))
    return 0 if payload["status"] == "ok" else 1


if __name__ == "__main__":
    raise SystemExit(main())
PY
